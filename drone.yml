kind: pipeline
type: kubernetes
name: default

steps:
  - name: build
    image: sankar31/baseimg:1.0
    commands:
      - sed -i 's/DRONE_BUILD_NUMBER/${DRONE_BUILD_NUMBER}/g' droneex-k8.yaml
      - mvn install -DskipTests=true -Dmaven.javadoc.skip=true -B -V
  - name : buildimage
    image: plugins/docker
    use_cache: true
    privileged: true
    settings:
      username: sankar31
      password: 123sinku
      repo: sankar31/droneex
      dockerfile: Dockerfile
      tags: ${DRONE_BUILD_NUMBER}
  - name : deploy
    image: sinlead/drone-kubectl
    settings:
      kubernetes_server:
        from_secret: k8s_server
      kubernetes_cert:
        from_secret: k8s_cert
      kubernetes_token:
        from_secret: k8s_token
    commands:
      - kubectl apply -f droneex-k8.yaml  --validate=false
  - name: notify-sucess
    image: sankar31/baseimg:1.0
    commands:
      - 'curl args:  -X POST -H ''Content-type: application/json'' --data ''{"text":"A new version has been deployed.."}'' https://outlook.office.com/webhook/ffe04023-cd7e-4430-a87c-69299028ab09@36da45f1-dd2c-4d1f-af13-5abe46b99921/IncomingWebhook/1fd1fcef4faf40fc98fe0fb50e62ccae/7c25e5d7-3646-4f9e-8530-90e625e5c975'
    when:
      status: success
  - name : notify-failure
    image: sankar31/baseimg:1.0
    commands:
      - 'curl args:  -X POST -H ''Content-type: application/json'' --data ''{"contentType":"application/vnd.microsoft.card.thumbnail","content":{"title":"Build failed..","subtitle":"Build failed..","text":"Build failed..","images":[{"url":"https://avatars2.githubusercontent.com/u/2181346?s=200&v=4","alt":"Drone CI"}],"tap":{"type":"imBack","value":"Tapped it!"}}}'' https://outlook.office.com/webhook/ffe04023-cd7e-4430-a87c-69299028ab09@36da45f1-dd2c-4d1f-af13-5abe46b99921/IncomingWebhook/1fd1fcef4faf40fc98fe0fb50e62ccae/7c25e5d7-3646-4f9e-8530-90e625e5c975'
    when:
      status: failure
